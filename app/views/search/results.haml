- @title = "Results for '#{@querystring}'"

.container
  .row
    .span3
      .well.sidebar-nav
        %ul.nav.nav-list
          - @facets.each do |ns, fields|
            - fields.each do |facet|
              - if !@results.facets[facet]['terms'].empty?
                %li.nav-header= facet.size < 4 ? facet.upcase : facet.capitalize

                - @results.facets[facet]['terms'].each do |f|

                  - if @filters[ns].nil? or @filters[ns][facet].nil? or !@filters[ns][facet].to_a.include?(f['term'])
                    - if !@filters[ns].nil?
                      - @new_fi = @filters.deep_merge({ns => {facet => @filters[ns][facet].to_a | f['term'].to_a}})
                    - else
                      - @new_fi = @filters.deep_merge({ns => {facet => f['term'].to_a}})

                    - if 'language' == facet
                      %li= link_to ISO_639.find(f['term']).nil? ? f['term'] + " (#{f['count']})" : ISO_639.find(f['term']).english_name + " (#{f['count']})",
                            url_for(:search_index, @querystring, :page => @page, :fi => @new_fi)
                    - else
                      %li= link_to f['term'] + " (#{f['count']})",
                            url_for(:search_index, @querystring, :page => @page, :fi => @new_fi)
                  - else
                    - if 'language' == facet
                      %li.active= link_to ISO_639.find(f['term']).nil? ? f['term']: ISO_639.find(f['term']).english_name,
                                  url_for(:search_index, @querystring, :page => @page, :fi => @filters.deep_merge({ns => {facet => @filters[ns][facet].reject { |x| f['term'] == x}}}))
                    - else
                      %li.active= link_to f['term'],
                                  url_for(:search_index, @querystring, :page => @page, :fi => @filters.deep_merge({ns => {facet => @filters[ns][facet].reject { |x| f['term'] == x}}}))

    .span9

      .pagination-centered
        - form_tag '/search', :method => 'get', :class => 'form-search' do
          = text_field_tag :q, :class => 'input-xxlarge search-query', :value => @querystring, :autofocus => true
          = submit_tag 'Search', :class => 'btn'

      .pagination-centered
        = paginate @results
        <b>#{@results.size}</b> of <b>#{@results.total}</b> results (#{@results.time} ms)

      =partial 'search/result', :collection => @results

      .pagination-centered
        = paginate @results

      %footer{:style => 'font-size: 1.1em;'} &copy; 2012 Deliberate Data

    %script{:src => "/javascripts/jquery.js"}
    %script{:src => "/javascripts/bootstrap.js"}
